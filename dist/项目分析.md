## 项目概览

豆瓣影视更新系统（Windows 适配版）是基于 PySide6 的桌面应用，提供账号管理、电影/内容清单管理、浏览器自动化登录/信息获取、数据库维护等功能。项目通过 Playwright 驱动真实浏览器（Chrome/Edge 等），并配合指纹与缓存目录为每个账号提供独立环境。

- 入口: `main.py`
- UI 框架: PySide6（Qt）
- 浏览器自动化: 自研封装于 `liulanqimokuai` 与 `liulanqi_gongcaozuo.py`
- 数据存储: SQLite（`data/accounts.db`）+ JSON 配置（`data/peizhi.json`）
- 日志/临时/备份: 由 `config.py` 统一管理目录

## 技术栈
- Python 3.x
- PySide6（Qt for Python）
- Playwright（在 `liulanqimokuai/browser_core.py` 二次封装）
- SQLite（`sqlite3`）
- 并发：`asyncio` + 线程（UI 与自动化隔离）

## 目录结构（关键模块）
- `main.py`: 主窗口与所有 Tab 页（账号/电影/内容/功能设置/操作设置/数据库管理/程序设置），应用启动逻辑，信号槽与数据加载
- `config.py`: `ProgramConfig` 封装程序根目录、数据/日志/临时/备份目录与默认浏览器路径探测、配置读写
- `data_manager.py`: 统一数据层，负责 SQLite 初始化/迁移、账号与电影/内容 CRUD、新的四类表（电影/电视/音乐/读书）管理
- `handlers/button_handlers.py`: UI 按钮事件的解耦实现（添加/编辑/删除账号、代理操作、电影/内容增删改、运行入口）
- `liulanqi_gongcaozuo.py`: 浏览器操作的高层封装（启动、打开页面、登录状态检测、Cookie 抽取、指纹应用、资源清理、事件监听）
- `renwuliucheng.py`: 任务流程控制器，编排浏览器初始化、打开豆瓣、拉取用户信息、根据模式（登录/更新）执行流程
- `liulanqimokuai/`: 浏览器内核与事件、指纹、隐身脚本、IP 定位等底层模块（如 `browser_core.py`、`stealth_scripts.py` 等）
- `utils.py`: 配置/缓存路径工具、指纹工具、账号缓存删除、指纹弹窗等
- `start_api.py`: 启动应用内 API 服务（后台线程）
- `ui/dialogs/`: 账号新增/编辑对话框与通用对话框基类
- `styles.py`: Fluent 风格样式（主窗口与指纹对话框等）

## 启动流程
1. 执行 `python main.py`：
   - 读取 `config.py` 初始化目录结构与配置对象 `config`
   - 开启内置 API 服务线程（`start_api.start_api()`）
   - 初始化 `QApplication` 并加载 Fluent 风格
   - 构建并显示 `AccountManagerWindow`
   - 通过 `DataManager` 加载账号、电影、内容数据与数据库信息
   - 通过 `load_config/apply_config` 恢复 UI 设置（浏览器路径、缓存路径、功能/间隔/运行设置等）

2. UI 操作（按钮 -> `handlers/button_handlers.py`）：
   - 账号管理：添加/编辑/删除、勾选批量操作、代理批量设置
   - 电影/内容管理：批量添加、批量删除、清空、更新星级
   - 功能/运行设置：保存至 `data/peizhi.json`

3. 打开浏览器（登录/更新）流程：
   - `main.AccountManagerWindow.open_browser()` 在后台线程开启事件循环，调用异步 `_safe_open_browser()`
   - 读取账号与配置，构造 `LiulanqiPeizhi`，创建 `RenwuLiucheng`
   - `RenwuLiucheng.qidong_liulanqi_liucheng()`：
     - 使用 `LiulanqiGongcaozuo.chushihua()` 启动浏览器（重试、残留进程清理、用户数据目录创建）
     - 打开豆瓣首页，智能等待关键元素
     - 注入指纹、读取登录状态与用户信息，通过 `DataManager` 更新账号字段（登录状态、Cookie 等）
   - 更新模式自动关闭浏览器；登录模式保持打开直至用户关闭，关闭时通过 `BrowserSignals.account_closed` 回收资源并刷新 UI

## 数据层与表结构
- 账号表 `accounts`：`(id, username[唯一], password, ck, nickname, account_id, login_status, homepage, login_time, proxy, running_status, note, zhiwenshuju, gouxuan)`
  - 新增字段：`gouxuan`（复选状态）、`zhiwenshuju`（指纹 JSON）
- 电影表 `movies`：`(id, movie_id, rating, type, created_at)`，其中 `type` 为 `specific|random`
- 内容表 `contents`：`(id, content, type, created_at)`，`type` 为 `specific|random`
- 四类媒体主数据表（去重/汇总用）：
  - `dianying(dianying_id, mingcheng, niandai)`
  - `dianshi(dianshi_id, mingcheng, niandai)`
  - `yinyue(yinyue_id, mingcheng, niandai)`
  - `dushu(dushu_id, mingcheng, niandai)`
- 一次性迁移：`data/new_data.db -> accounts.db`（存在即迁移，完成后重命名 `new_data.db.migrated`）
- JSON 配置：`data/peizhi.json`（浏览器路径、缓存路径、功能/间隔/运行设置等）

## 浏览器封装关键点（`liulanqi_gongcaozuo.py`）
- 事件监听：浏览器启动、关闭、断开、页面加载、URL 变化、错误等；统一写 UI 回调与日志
- 指纹：
  - 初始化时通过 `utils.ensure_account_fingerprint(account_id)` 确保存在
  - 应用到 Context 额外请求头与页面（注入 JS）；可设置地理位置
- Cookie：仅在已登录状态获取并保存（`context.cookies()` -> 字符串），未登录则清空 Cookie
- 资源管理：
  - 启动前清理残留 Chrome 进程（可选依赖 `psutil`）
  - 关闭时优先异步关闭控制器，否则降级调用拼音 API，再多轮 GC 与进程终止兜底

## UI 交互与信号
- `BrowserSignals`：`error/info/account_closed`
- `active_browser_sessions`：按用户名记录线程、停止事件与流程控制对象，避免重复启动
- 账号复选状态与数据库 `gouxuan` 字段同步（全选/取消全选）

## 常见操作路径
- 账号添加：`handlers.add_account_handler` -> `ui/dialogs/AccountDialog` -> `DataManager.add_account`（自动生成并保存指纹）
- 打开浏览器：`main.open_browser` -> `_safe_open_browser` -> `RenwuLiucheng` -> `LiulanqiGongcaozuo`
- 电影/内容导入：多行输入框 -> 解析、去重、校验 -> `DataManager.save_movies/contents` -> UI 刷新
- 数据库管理：左侧表概览（行数），右侧列表与添加/编辑/删除对话框 -> `DataManager.add/update/delete`

## 运行与环境
- 依赖安装（使用国内镜像）：
```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```
- Windows 下可在“程序设置”中自动/手动选择浏览器可执行文件与缓存路径
- 建议：首次运行先在“程序设置”设置 `浏览器路径` 与 `缓存路径`，并在“账号管理”中添加账号

## 日志与文件
- 日志：`logs/app.log`（`config.get_log_path()`）
- 数据库：`data/accounts.db`
- 配置：`data/peizhi.json`
- 临时：`temp/`
- 备份：`backup/`

## 测试/脚本
- `tests/` 内含基础测试样例与浏览器相关测试（需要本地环境与浏览器依赖）
- `test_delete_account_cache.py` 提供缓存与指纹清理行为验证

## 风险与改进建议
- 浏览器依赖：需本地安装 Chrome/Edge 等；建议在 UI 中做更健壮的可用性检测与提示
- 指纹管理：指纹生成/应用路径稳定，但实际对反爬效果依赖目标站策略；建议完善可视化与可配置项
- 异常与资源清理：已做充分兜底，但仍建议为 Playwright 层增加更多状态检查与重连策略
- 并发：UI 线程与浏览器线程交互已通过信号与事件封装，仍建议梳理跨线程共享状态（如 `active_browser_sessions`）的一致性策略
- 配置：当前 `peizhi.json` 直接覆盖保存，建议引入 schema 校验与版本升级迁移

## 关键文件速览
- `main.py`：主窗口、Tab、信号、浏览器会话管理
- `config.py`：目录/路径/系统信息与配置读写、默认浏览器路径探测
- `data_manager.py`：数据库建表/迁移、账号/电影/内容 CRUD、四类媒体表管理
- `handlers/button_handlers.py`：按钮事件解耦、复杂对话框逻辑
- `liulanqi_gongcaozuo.py`：浏览器启动/状态检测/Cookie/指纹/清理的一体化封装
- `renwuliucheng.py`：高层执行编排（登录/更新两模式）
- `utils.py`：指纹/缓存/配置工具与对话框

---
如需我补充启动指南截图、执行时序图或类图，请告诉我使用场景，我将追加到本文档中。
